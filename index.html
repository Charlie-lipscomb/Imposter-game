<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Imposter Guess the Word</title>
<style>
  body{font-family:Arial,Helvetica,sans-serif;background:#0f1724;color:#e8f0fb;display:flex;justify-content:center;align-items:center;min-height:100vh;margin:0}
  .card{background:#1a1f2b;padding:18px;border-radius:12px;width:680px;max-width:96%}
  input,button,textarea{width:100%;padding:10px;margin:6px 0;border-radius:6px;border:none;box-sizing:border-box}
  .btn-primary{background:#4a90e2;color:white}
  .btn-success{background:#28a745;color:white}
  .player-list div,.clue-item{padding:8px;background:rgba(255,255,255,0.03);margin-bottom:6px;border-radius:6px}
  #gameUI,#voteSection{display:none}
  .small{font-size:13px;color:#9aa7b7}
  .row{display:flex;gap:8px}
  .col2{flex:1}
  .inline-btn{width:auto;padding:8px 12px}
  #results{margin-top:12px;padding:10px;background:#22303f;border-radius:8px}
</style>
</head>
<body>

<div class="card" id="lobbyCard">
  <h2>Imposter Guess the Word</h2>

  <label class="small">Your name</label>
  <input id="name" placeholder="Your name"/>

  <div class="row">
    <button id="createBtn" class="btn-primary inline-btn">Create Lobby</button>
    <input id="joinCode" placeholder="Lobby Code" class="col2"/>
    <button id="joinBtn" class="btn-primary inline-btn">Join</button>
  </div>

  <div id="playersCard" style="display:none;margin-top:12px">
    <div class="row" style="align-items:center;justify-content:space-between">
      <div>Lobby Code: <strong id="codeDisplay">â€“</strong></div>
      <div class="small">Players: <span id="playersCount">0</span></div>
    </div>
    <div id="playersList" class="player-list"></div>
    <div style="margin-top:10px">
      <button id="startBtn" class="btn-success" style="display:none">Start Game</button>
    </div>
    <div class="small" style="margin-top:8px">Host can start when there are at least 3 players</div>
  </div>
</div>

<div class="card" id="gameUI">
  <h2>Game Running</h2>
  <div class="small" id="roleDisplay"></div>
  <div class="small" id="wordDisplay" style="margin-bottom:8px"></div>

  <h3>Clues</h3>
  <div id="clueList" style="max-height:200px;overflow:auto;margin-bottom:8px"></div>

  <div id="turnArea">
    <div id="turnInfo" class="small"></div>

    <div id="clueSection">
      <textarea id="clueInput" placeholder="Enter clue"></textarea>
      <div class="row">
        <button id="submitClueBtn" class="btn-primary inline-btn">Submit</button>
        <div class="small">Round: <span id="roundCounter">1</span> of 2</div>
      </div>
    </div>
  </div>

  <div id="voteSection">
    <h3>Vote for Imposter</h3>
    <div id="voteList"></div>
    <button id="submitVoteBtn" class="btn-success">Submit Vote</button>
  </div>

  <div id="results"></div>
</div>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
import { getDatabase, ref, set, get, onValue, update, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js';

const firebaseConfig = {
  apiKey: "AIzaSyCXqev3PU7OfSRtDJ6BGQ3Alz3n2_lwuAk",
  authDomain: "imposter-game-3b77e.firebaseapp.com",
  databaseURL: "https://imposter-game-3b77e-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "imposter-game-3b77e",
  storageBucket: "imposter-game-3b77e.firebasestorage.app",
  messagingSenderId: "929913946798",
  appId: "1:929913946798:web:e961f81be2c95b284f633f",
  measurementId: "G-KQNCHZH2EL"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let clientId = localStorage.getItem("id") || ("c_" + Math.random().toString(36).slice(2));
localStorage.setItem("id", clientId);

let currentLobby = null;
const maxRounds = 2;

const el = id => document.getElementById(id);

// word picker
async function getRandomWord() {
  const snap = await get(ref(db, "words"));
  const words = snap.val() || {};
  const arr = Object.values(words);
  if (arr.length === 0) return "unknown";
  return arr[Math.floor(Math.random() * arr.length)];
}

// create lobby
async function createLobby(){
  const name = el("name").value.trim();
  if (!name) return alert("Enter a name");
  const code = Math.random().toString(36).slice(2,8).toUpperCase();
  currentLobby = code;

  await set(ref(db, "lobbies/" + code), {
    hostId: clientId,
    created: serverTimestamp(),
    started: false
  });

  await set(ref(db, "lobbies/" + code + "/players/" + clientId), {
    name,
    clientId
  });

  el("playersCard").style.display = "block";
  el("codeDisplay").textContent = code;
  listenLobby(code);
}

// join
async function joinLobby(){
  const name = el("name").value.trim();
  const code = el("joinCode").value.trim().toUpperCase();
  if (!name || !code) return alert("Enter details");
  const snap = await get(ref(db, "lobbies/" + code));
  if (!snap.exists()) return alert("No lobby");

  currentLobby = code;

  await set(ref(db, "lobbies/" + code + "/players/" + clientId), {
    name,
    clientId
  });

  el("playersCard").style.display = "block";
  el("codeDisplay").textContent = code;
  listenLobby(code);
}

// start
async function startGame(){
  const snap = await get(ref(db, "lobbies/" + currentLobby));
  const lobby = snap.val();
  const players = lobby.players;
  const keys = Object.keys(players);
  if (keys.length < 3) return alert("Need 3 players");

  await startNewRound();
}

// start round
async function startNewRound(){
  const snap = await get(ref(db, "lobbies/" + currentLobby));
  const lobby = snap.val();
  const players = lobby.players;
  const keys = Object.keys(players);

  const imposter = keys[Math.floor(Math.random() * keys.length)];
  const word = await getRandomWord();
  const order = keys.slice().sort(()=>Math.random() - 0.5);

  const updates = {
    started: true,
    voting: false,
    word,
    turnOrder: order,
    currentTurn: 0,
    clues: [],
    round: 1
  };

  keys.forEach(k=>{
    updates["players/" + k + "/role"] = k === imposter ? "imposter" : "player";
  });

  await update(ref(db, "lobbies/" + currentLobby), updates);
  await set(ref(db, "lobbies/" + currentLobby + "/votes"), {});
}

// submit clue
async function submitClue(){
  const clue = el("clueInput").value.trim();
  if (!clue) return;

  const snap = await get(ref(db, "lobbies/" + currentLobby));
  const lobby = snap.val();
  const clues = lobby.clues || [];
  const order = lobby.turnOrder;
  const turn = lobby.currentTurn;
  const next = (turn + 1) % order.length;

  clues.push({
    player: clientId,
    text: clue,
    ts: Date.now()
  });

  const total = clues.length;
  const cycle = Math.ceil(total / order.length);

  const updates = {
    clues,
    currentTurn: next,
    round: Math.min(maxRounds, cycle)
  };

  if (cycle > maxRounds){
    updates.voting = true;
  }

  await update(ref(db, "lobbies/" + currentLobby), updates);
  el("clueInput").value = "";
}

// render lobby
function renderPlayers(players){
  el("playersList").innerHTML = "";
  const keys = Object.keys(players);
  keys.forEach(k=>{
    const d = document.createElement("div");
    d.textContent = players[k].name + (k === clientId ? " (you)" : "");
    el("playersList").appendChild(d);
  });
  el("playersCount").textContent = keys.length;
}

function showTurnUI(lobby){
  const me = clientId;
  const players = lobby.players;
  const order = lobby.turnOrder;
  const turn = lobby.currentTurn;
  const currentPlayer = order[turn];

  el("roundCounter").textContent = lobby.round;

  if (lobby.voting){
    el("clueSection").style.display = "none";
    el("voteSection").style.display = "block";
    buildVoteList(players);
    el("turnInfo").textContent = "Voting in progress";
    return;
  }

  el("voteSection").style.display = "none";

  if (currentPlayer === me){
    el("clueSection").style.display = "block";
    el("turnInfo").textContent = "Your turn, enter a clue";
  } else {
    el("clueSection").style.display = "none";
    el("turnInfo").textContent = "Waiting for " + players[currentPlayer].name;
  }
}

function buildVoteList(players){
  el("voteList").innerHTML = "";
  Object.keys(players).forEach(k=>{
    if (k === clientId) return;
    const b = document.createElement("button");
    b.textContent = players[k].name;
    b.style.display = "block";
    b.onclick = ()=> {
      el("voteList").querySelectorAll("button").forEach(x=>x.style.background = "");
      b.style.background = "#4a90e2";
      el("voteList").setAttribute("data-vote", k);
    };
    el("voteList").appendChild(b);
  });
}

// submit vote
async function submitVote(){
  const voted = el("voteList").getAttribute("data-vote");
  if (!voted) return alert("Pick a player");

  await update(ref(db, "lobbies/" + currentLobby + "/votes/" + clientId), {
    voted
  });

  checkVotes();
}

// tally votes
async function checkVotes(){
  const snap = await get(ref(db, "lobbies/" + currentLobby));
  const lobby = snap.val();
  const votes = lobby.votes || {};
  const players = lobby.players;
  const totalNeeded = Object.keys(players).length;

  if (Object.keys(votes).length < totalNeeded) return;

  const counts = {};
  Object.values(votes).forEach(v=>{
    counts[v.voted] = (counts[v.voted] || 0) + 1;
  });

  let max = -1;
  let most = [];
  Object.keys(counts).forEach(k=>{
    if (counts[k] > max){
      max = counts[k];
      most = [k];
    } else if (counts[k] === max){
      most.push(k);
    }
  });

  const resultBox = el("results");
  if (most.length > 1){
    resultBox.textContent = "Tie. No one was eliminated.";
  } else {
    const eliminated = most[0];
    resultBox.textContent = "Eliminated player: " + players[eliminated].name;
  }

  setTimeout(startNewRound, 3000);
}

// live updates
function listenLobby(code){
  const lobbyRef = ref(db, "lobbies/" + code);
  onValue(lobbyRef, snap=>{
    const data = snap.val();
    if (!data) return;

    renderPlayers(data.players || {});
    el("lobbyCard").style.display = data.started ? "none" : "block";
    el("gameUI").style.display = data.started ? "block" : "none";

    if (!data.started) return;

    const myRole = data.players?.[clientId]?.role || "Unknown";
    el("roleDisplay").textContent = "Role: " + myRole;
    el("wordDisplay").textContent = myRole === "imposter" ? "Word: ???" : "Word: " + data.word;

    renderClues(data.clues || [], data.players || {});
    showTurnUI(data);
  });
}

// render clues
function renderClues(clues, players){
  el("clueList").innerHTML = "";
  clues.forEach(c=>{
    const d = document.createElement("div");
    d.className = "clue-item";
    d.innerHTML = "<strong>" + players[c.player].name + "</strong>: " + c.text;
    el("clueList").appendChild(d);
  });
}

// buttons
el("createBtn").onclick = createLobby;
el("joinBtn").onclick = joinLobby;
el("startBtn").onclick = startGame;
el("submitClueBtn").onclick = submitClue;
el("submitVoteBtn").onclick = submitVote;
</script>

</body>
</html>
