<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Imposter — Guess the Word</title>
<style>
  body{font-family:Arial,Helvetica,sans-serif;background:#0f1724;color:#e8f0fb;display:flex;justify-content:center;align-items:center;min-height:100vh;margin:0}
  .card{background:#1a1f2b;padding:18px;border-radius:12px;width:680px;max-width:96%}
  input,button,textarea{width:100%;padding:10px;margin:6px 0;border-radius:6px;border:none;box-sizing:border-box}
  .btn-primary{background:#4a90e2;color:white}
  .btn-success{background:#28a745;color:white}
  .player-list div,.clue-item{padding:8px;background:rgba(255,255,255,0.03);margin-bottom:6px;border-radius:6px}
  #gameUI,#voteSection{display:none}
  .small{font-size:13px;color:#9aa7b7}
  .row{display:flex;gap:8px}
  .col2{flex:1}
  .inline-btn{width:auto;padding:8px 12px}
  #results{margin-top:12px;padding:10px;background:#22303f;border-radius:8px}
</style>
</head>
<body>
  <div class="card" id="lobbyCard">
    <h2>Imposter — Guess the Word</h2>

    <label class="small">Your name</label>
    <input id="name" placeholder="Your name" />

    <div class="row">
      <button id="createBtn" class="btn-primary inline-btn">Create Lobby</button>
      <input id="joinCode" placeholder="Lobby Code" class="col2" />
      <button id="joinBtn" class="btn-primary inline-btn">Join</button>
    </div>

    <div id="playersCard" style="display:none;margin-top:12px">
      <div class="row" style="align-items:center;justify-content:space-between">
        <div>Lobby Code: <strong id="codeDisplay">—</strong></div>
        <div class="small">Players: <span id="playersCount">0</span></div>
      </div>

      <div id="playersList" class="player-list" style="margin-top:8px"></div>
      <div style="margin-top:10px">
        <button id="startBtn" class="btn-success" style="display:none">Start Game</button>
      </div>
      <div class="small" style="margin-top:8px">Host can start the game once there are at least 3 players</div>
    </div>
  </div>

  <!-- Game UI -->
  <div class="card" id="gameUI">
    <h2>Game In Progress</h2>
    <div class="small" id="roleDisplay">Role: —</div>
    <div class="small" id="wordDisplay" style="margin-bottom:8px">Word: —</div>

    <h3>Clues (everyone sees them)</h3>
    <div id="clueList" style="max-height:200px;overflow:auto;margin-bottom:8px"></div>

    <div id="turnArea" style="margin-top:8px">
      <div id="turnInfo" class="small" style="margin-bottom:6px">Turn info</div>
      <div id="clueSection">
        <textarea id="clueInput" placeholder="Write a short clue (no full word)"></textarea>
        <div style="display:flex;gap:8px;align-items:center">
          <button id="submitClueBtn" class="btn-primary inline-btn">Submit clue</button>
          <div class="small">Rounds: <span id="roundCounter">0</span> / 2</div>
        </div>
      </div>
    </div>

    <div id="voteSection" style="margin-top:12px">
      <h3>Vote for the Imposter</h3>
      <div id="voteList" style="margin-bottom:8px"></div>
      <button id="submitVoteBtn" class="btn-success">Submit Vote</button>
    </div>

    <div id="results"></div>
  </div>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
import {
  getDatabase, ref, set, get, onValue, update, serverTimestamp
} from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js';

const firebaseConfig = {
  apiKey: "AIzaSyDlm1nd6P6VY6HiFLgy2rZPeLLr-VwYaD4",
  authDomain: "imposter-5142b.firebaseapp.com",
  databaseURL: "https://imposter-5142b-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "imposter-5142b",
  storageBucket: "imposter-5142b.appspot.com",
  messagingSenderId: "500677632460",
  appId: "1:500677632460:web:236568f1cb93c31a7bbd69",
  measurementId: "G-RWF1030VF1"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let clientId = localStorage.getItem('imposter_clientId') || ('c_'+Math.random().toString(36).slice(2,10));
localStorage.setItem('imposter_clientId', clientId);

let currentLobby = null;
const roundsNeeded = 2;

const el = id => document.getElementById(id);

// render functions
function renderPlayers(players){
  const list = el('playersList'); list.innerHTML = '';
  const keys = Object.keys(players || {});
  keys.forEach(k=>{
    const p = players[k];
    const div = document.createElement('div');
    div.textContent = (p.name || 'Unknown') + (k === clientId ? ' (you)' : '');
    list.appendChild(div);
  });
  el('playersCount').textContent = keys.length;
}

function updateStartVisibility(hostId, players){
  const keys = Object.keys(players || {});
  el('startBtn').style.display = (hostId === clientId && keys.length >= 3) ? 'inline-block' : 'none';
}

function renderClues(clues = [], players = {}){
  const list = el('clueList'); list.innerHTML = '';
  clues.forEach(c=>{
    const div = document.createElement('div');
    div.className = 'clue-item';
    const name = players?.[c.player]?.name || 'Unknown';
    const time = c.ts ? new Date(c.ts).toLocaleTimeString() : '';
    div.innerHTML = `<strong>${name}:</strong> ${c.text} <span class="small"> ${time}</span>`;
    list.appendChild(div);
  });
}

function updateTurnUI(lobby){
  const me = clientId;
  const players = lobby.players || {};
  const order = lobby.turnOrder || Object.keys(players);
  const currentTurnIdx = lobby.currentTurn || 0;
  const totalClues = (lobby.clues || []).length;
  const round = Math.floor(totalClues / order.length) + 1;
  el('roundCounter').textContent = Math.min(roundsNeeded, round);

  const currentPlayerId = order[currentTurnIdx];
  if(lobby.voting){
    el('turnInfo').textContent = 'Voting in progress';
    el('clueSection').style.display = 'none';
    el('voteSection').style.display = 'block';
    return;
  }

  el('voteSection').style.display = 'none';
  if(currentPlayerId === me){
    el('turnInfo').textContent = 'It is your turn. Give a clue.';
    el('clueSection').style.display = 'block';
  } else {
    const playerName = players?.[currentPlayerId]?.name || 'Unknown';
    el('turnInfo').textContent = `Waiting for ${playerName} to give a clue.`;
    el('clueSection').style.display = 'none';
  }
}

// pick random word from Firebase /words
async function getRandomWord() {
  const snap = await get(ref(db, 'words'));
  const wordsObj = snap.val() || {};
  const wordsArr = Object.values(wordsObj);
  if(wordsArr.length === 0) return 'unknown';
  return wordsArr[Math.floor(Math.random() * wordsArr.length)];
}

// create / join / start lobby
async function createLobby(){
  const name = el('name').value.trim();
  if(!name) return alert('Enter your name');
  const code = Math.random().toString(36).substring(2,8).toUpperCase();
  currentLobby = code;
  await set(ref(db, 'lobbies/' + code), { hostId: clientId, started: false, created: serverTimestamp() });
  await set(ref(db, 'lobbies/' + code + '/players/' + clientId), { name, clientId });
  el('playersCard').style.display = 'block';
  el('codeDisplay').textContent = code;
  listenLobby(code);
}

async function joinLobby(){
  const name = el('name').value.trim();
  const code = el('joinCode').value.trim().toUpperCase();
  if(!name || !code) return alert('Enter name and code');
  const snap = await get(ref(db, 'lobbies/' + code));
  if(!snap.exists()) return alert('Lobby not found');
  currentLobby = code;
  await set(ref(db, 'lobbies/' + code + '/players/' + clientId), { name, clientId });
  el('playersCard').style.display = 'block';
  el('codeDisplay').textContent = code;
  listenLobby(code);
}

async function startGame(){
  if(!currentLobby) return;
  const snap = await get(ref(db, 'lobbies/' + currentLobby));
  const lobby = snap.val();
  const players = lobby.players || {};
  const keys = Object.keys(players);
  if(keys.length < 3) return alert('Need at least 3 players');

  const imposter = keys[Math.floor(Math.random()*keys.length)];
  const word = await getRandomWord();
  const turnOrder = keys.slice().sort(()=>Math.random()-0.5);

  const updates = {
    started: true,
    voting: false,
    word,
    turnOrder,
    currentTurn: 0,
    clues: []
  };

  keys.forEach(k=>{
    updates['players/' + k + '/role'] = (k === imposter) ? 'imposter' : 'player';
  });

  await update(ref(db, 'lobbies/' + currentLobby), updates);
  await set(ref(db, 'lobbies/' + currentLobby + '/votes'), {});
}

// event listeners
el('createBtn').onclick = createLobby;
el('joinBtn').onclick = joinLobby;
el('startBtn').onclick = startGame;

// listen lobby
function listenLobby(code){
  currentLobby = code;
  const lobbyRef = ref(db, 'lobbies/' + code);
  onValue(lobbyRef, snap=>{
    const data = snap.val();
    if(!data) return;
    renderPlayers(data.players || {});
    updateStartVisibility(data.hostId, data.players || {});
    el('lobbyCard').style.display = data.started ? 'none' : 'block';
    el('gameUI').style.display = data.started ? 'block' : 'none';
    if(data.started){
      const role = data.players?.[clientId]?.role || 'Unknown';
      el('roleDisplay').textContent = 'Your role: ' + role;
      el('wordDisplay').textContent = 'Word: ' + (role === 'imposter' ? '???' : (data.word || '—'));
      renderClues(data.clues || [], data.players || {});
    }
  });
}
</script>
</body>
</html>
