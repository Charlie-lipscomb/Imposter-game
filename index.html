<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Imposter Lobby</title>
<style>
body { font-family: Arial, sans-serif; padding: 20px; background: #1a11a1; colour: white; text-align: centre; }
#lobby, #game { background: #2a2a2a; padding: 20px; border-radius: 12px; max-width: 400px; margin: auto; box-shadow: 0 0 10px rgba(0,0,0,0.6); }
input { width: 90%; padding: 10px; border-radius: 6px; border: none; margin-bottom: 12px; }
button { background: #4a90e2; border: none; padding: 10px 20px; border-radius: 6px; colour: white; cursor: pointer; font-size: 16px; }
button:hover { background: #357ac9; }
ul { list-style: none; padding: 0; }
li { background: #3a3a3a; padding: 8px; border-radius: 6px; margin-bottom: 6px; }
#startBtn { background: #28a745; }
#startBtn:hover { background: #1f7f35; }
</style>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getDatabase, ref, set, get, child, onValue, update } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDlm1nd6P6VY6HiFLgy2rZPeLLr-VwYaD4",
  authDomain: "imposter-5142b.firebaseapp.com",
  databaseURL: "https://imposter-5142b-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "imposter-5142b",
  storageBucket: "imposter-5142b.firebasestorage.app",
  messagingSenderId: "500677632460",
  appId: "1:500677632460:web:236568f1cb93c31a7bbd69",
  measurementId: "G-RWF1030VF1"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let host = false;
let playerName = "";
let currentCode = "";

function generateCode() {
  return Math.random().toString(36).substring(2, 7).toUpperCase();
}

window.createLobby = async function () {
  playerName = document.getElementById("playerName").value.trim();
  if (!playerName) return alert("Enter your name");

  const code = generateCode();
  currentCode = code;
  const lobbyRef = ref(db, `lobbies/${code}`);

  try {
    await set(lobbyRef, {
      host: playerName,
      players: { [playerName]: true },
      state: "lobby"
    });
    host = true;
    joinLobbyUI(code);
  } catch (err) {
    alert("Failed to create lobby: " + err.message);
  }
};

window.joinLobby = async function () {
  playerName = document.getElementById("playerName").value.trim();
  const code = document.getElementById("lobbyCode").value.trim().toUpperCase();
  if (!playerName || !code) return alert("Enter name and code");

  const lobbyRef = ref(db, `lobbies/${code}`);
  const snap = await get(lobbyRef);

  if (!snap.exists()) return alert("Lobby not found");

  try {
    await set(ref(db, `lobbies/${code}/players/${playerName}`), true);
    currentCode = code;
    host = snap.val().host === playerName;
    joinLobbyUI(code);
  } catch (err) {
    alert("Error joining: " + err.message);
  }
};

function joinLobbyUI(code) {
  document.getElementById("lobby").style.display = "none";
  document.getElementById("game").style.display = "block";
  document.getElementById("codeDisplay").innerText = code;

  const playersRef = ref(db, `lobbies/${code}/players`);

  onValue(playersRef, snap => {
    const list = document.getElementById("playerList");
    const startBtn = document.getElementById("startBtn");
    list.innerHTML = "";
    let count = 0;

    snap.forEach(child => {
      count++;
      const li = document.createElement("li");
      li.textContent = child.key;
      list.appendChild(li);
    });

    if (host && count >= 3) {
      startBtn.style.display = "inline-block";
    } else {
      startBtn.style.display = "none";
    }
  });
}

window.startGame = async function () {
  if (!host) return;

  const lobbyRef = ref(db, `lobbies/${currentCode}/players`);
  const snap = await get(lobbyRef);

  const names = Object.keys(snap.val());
  const roles = {};

  const imposterCount = Math.max(1, Math.floor(names.length / 4));
  const shuffled = names.sort(() => Math.random() - 0.5);

  for (let i = 0; i < names.length; i++) {
    roles[names[i]] = i < imposterCount ? "imposter" : "crewmate";
  }

  await update(ref(db, `lobbies/${currentCode}`), {
    roles: roles,
    state: "started"
  });

  alert("Game started");
};
</script>
</head>

<body>
<div id="lobby">
  <h2>Imposter Lobby</h2>
  <input id="playerName" placeholder="Your name" />
  <br>
  <button onclick="createLobby()">Create Lobby</button>
  <br><br>
  <input id="lobbyCode" placeholder="Code to join" />
  <button onclick="joinLobby()">Join</button>
</div>

<div id="game" style="display:none;">
  <h2>Lobby Code: <span id="codeDisplay"></span></h2>
  <h3>Players:</h3>
  <ul id="playerList"></ul>
  <button id="startBtn" onclick="startGame()" style="display:none;">Start Game</button>
</div>
</body>
</html>
