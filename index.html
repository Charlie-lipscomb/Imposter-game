<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Imposter - Social Deduction Game</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-firestore-compat.js"></script>
    
    <style>
        /* --- CSS STYLING (FOR SLEEK UI) --- */
        :root {
            --primary-color: #4CAF50; /* Green */
            --secondary-color: #2196F3; /* Blue */
            --background-color: #2c3e50; /* Dark Blue/Grey */
            --card-color: #34495e; /* Slightly Lighter Dark */
            --text-color: #ecf0f1; /* Light Grey */
            --accent-color: #f39c12; /* Orange for alerts */
            --border-radius: 8px;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--background-color);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        /* --- Screens --- */
        .screen {
            max-width: 600px;
            width: 100%;
            display: none;
            text-align: center;
            animation: fadeIn 0.5s ease-in-out;
        }

        .screen.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h1 {
            color: var(--primary-color);
            margin-bottom: 20px;
        }

        /* --- Cards and Boxes --- */
        .lobby-card, .player-list-card, .clue-box {
            background: var(--card-color);
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }

        h2 {
            margin-bottom: 20px;
            color: var(--text-color);
        }

        /* --- Inputs and Buttons --- */
        input[type="text"] {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 2px solid var(--card-color);
            border-radius: var(--border-radius);
            background-color: #2c3e50;
            color: var(--text-color);
            transition: border-color 0.3s;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: var(--secondary-color);
        }

        .primary-btn, .secondary-btn {
            width: 100%;
            padding: 12px;
            margin-bottom: 10px;
            border: none;
            border-radius: var(--border-radius);
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.1s;
        }

        .primary-btn {
            background-color: var(--primary-color);
            color: white;
        }

        .secondary-btn {
            background-color: var(--secondary-color);
            color: white;
        }

        .primary-btn:hover { background-color: #43a047; }
        .secondary-btn:hover { background-color: #1e88e5; }
        .primary-btn:active, .secondary-btn:active { transform: scale(0.98); }

        .primary-btn:disabled, .secondary-btn:disabled {
            background-color: #7f8c8d;
            cursor: not-allowed;
        }

        .separator {
            color: #95a5a6;
            margin: 15px 0;
            font-size: 0.9em;
            font-style: italic;
        }

        .footer-note {
            font-size: 0.8em;
            color: #95a5a6;
        }

        /* --- Game Screen Specifics --- */
        .game-area {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .clue-box {
            flex: 2;
            text-align: center;
        }

        .secret-word {
            font-size: 2.5em;
            font-weight: bold;
            color: var(--accent-color);
            margin-bottom: 20px;
        }

        .game-header p {
            font-size: 0.9em;
            margin-bottom: 5px;
            color: #bdc3c7;
        }
        
        #role-display {
            color: var(--primary-color);
            margin: 15px 0 25px 0;
            font-size: 1.5em;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.5);
        }

        .player-list-card {
            flex: 1;
        }

        #player-list {
            list-style: none;
            padding: 0;
            text-align: left;
        }

        #player-list li {
            padding: 8px 0;
            border-bottom: 1px solid #3e526a;
        }

        #player-list li:last-child {
            border-bottom: none;
        }

        #input-area {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        #clue-input {
            flex-grow: 1;
            margin-bottom: 0;
        }

        #submit-clue-btn {
            width: auto;
            padding: 10px 15px;
            margin-bottom: 0;
        }

        /* Responsive adjustment for smaller screens */
        @media (max-width: 500px) {
            .game-area {
                flex-direction: column;
            }
            .player-list-card {
                order: -1; /* Move player list above the clue box on mobile */
            }
        }
    </style>
</head>
<body>

    <div id="lobby-screen" class="screen active">
        <h1>üïµÔ∏è Find the Imposter</h1>
        <div class="lobby-card">
            <h2>Join or Start a Game</h2>
            <input type="text" id="username-input" placeholder="Enter Your Name" maxlength="15">
            <button id="create-lobby-btn" class="primary-btn" disabled>Create New Lobby</button>
            <div class="separator">OR</div>
            <input type="text" id="code-input" placeholder="Enter Lobby Code">
            <button id="join-lobby-btn" class="secondary-btn" disabled>Join Lobby</button>
        </div>
        <p class="footer-note">A word game of secrets and suspicion. Requires Firebase connection.</p>
    </div>

    <div id="game-screen" class="screen">
        <div class="game-header">
            <p>Lobby Code: <span id="display-code"></span></p>
            <h2 id="role-display">Loading Role...</h2>
        </div>

        <div class="game-area">
            <div class="clue-box">
                <p id="word-display" class="secret-word">Waiting for game start...</p>
                <div id="status-message">Waiting for all players...</div>
                <div id="input-area" style="display: none;">
                    <input type="text" id="clue-input" placeholder="Your one-word clue" maxlength="20">
                    <button id="submit-clue-btn">Submit Clue</button>
                </div>
            </div>

            <div class="player-list-card">
                <h3>Players</h3>
                <ul id="player-list">
                    </ul>
            </div>
        </div>
        
        <button id="start-game-btn" class="primary-btn" style="display: none;">Start Game (Min 3 Players)</button>
        <button id="vote-btn" class="secondary-btn" style="display: none;">Start Voting</button>
    </div>

    <script>
        /* --- JAVASCRIPT LOGIC (CLIENT-SIDE IMPLEMENTATION WITH FIREBASE) --- */
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- 1. FIREBASE CONFIGURATION & INITIALIZATION ---
            // NOTE: Using the 'compat' version above requires using the 'firebase.XXX()' global style.
            const firebaseConfig = {
              apiKey: "AIzaSyDlm1nd6P6VY6HiFLgy2rZPeLLr-VwYaD4",
              authDomain: "imposter-5142b.firebaseapp.com",
              projectId: "imposter-5142b",
              storageBucket: "imposter-5142b.firebasestorage.app",
              messagingSenderId: "500677632460",
              appId: "1:500677632460:web:236568f1cb93c31a7bbd69",
              measurementId: "G-RWF1030VF1"
            };

            // Initialize Firebase and Firestore
            const app = firebase.initializeApp(firebaseConfig);
            // Firestore reference using the 'compat' style
            const db = firebase.firestore(); 
            const lobbiesCollection = db.collection('lobbies');
            
            // --- DOM AND STATE VARIABLES ---
            const lobbyScreen = document.getElementById('lobby-screen');
            const gameScreen = document.getElementById('game-screen');
            const usernameInput = document.getElementById('username-input');
            const codeInput = document.getElementById('code-input');
            const joinLobbyBtn = document.getElementById('join-lobby-btn');
            const createLobbyBtn = document.getElementById('create-lobby-btn');
            const startGameBtn = document.getElementById('start-game-btn');
            const wordDisplay = document.getElementById('word-display');
            const roleDisplay = document.getElementById('role-display');
            const statusMessage = document.getElementById('status-message');
            const inputArea = document.getElementById('input-area');
            const submitClueBtn = document.getElementById('submit-clue-btn');
            const clueInput = document.getElementById('clue-input');

            let myUsername = '';
            let lobbyCode = '';
            let isHost = false; 

            // --- UI HELPERS ---

            // Enable/Disable buttons based on input content
            const checkInputs = () => {
                const hasUsername = usernameInput.value.trim().length > 0;
                const hasCode = codeInput.value.trim().length > 0;
                joinLobbyBtn.disabled = !(hasUsername && hasCode); 
                createLobbyBtn.disabled = !hasUsername;
            };

            usernameInput.addEventListener('input', checkInputs);
            codeInput.addEventListener('input', checkInputs);

            function updatePlayerList(players) {
                const list = document.getElementById('player-list');
                list.innerHTML = '';
                players.forEach(player => {
                    const li = document.createElement('li');
                    li.textContent = player;
                    list.appendChild(li);
                });
            }

            function joinGame(code, username, hostStatus) {
                isHost = hostStatus;
                lobbyScreen.classList.remove('active');
                gameScreen.classList.add('active');
                document.getElementById('display-code').textContent = code;
                roleDisplay.textContent = `Welcome, ${username}! Waiting for game start...`;
            }

            // --- 2. FIREBASE-CONNECTED LOBBY LOGIC ---
            
            // Updated Create Lobby Logic
            createLobbyBtn.addEventListener('click', async () => {
                myUsername = usernameInput.value.trim();
                if (myUsername) {
                    lobbyCode = Math.random().toString(36).substring(2, 6).toUpperCase(); // 4-char code
                    
                    try {
                        // Use firebase.firestore.FieldValue.serverTimestamp() with compat library
                        await lobbiesCollection.doc(lobbyCode).set({
                            host: myUsername,
                            status: 'waiting', 
                            players: [{ name: myUsername, role: 'Host', status: 'connected' }],
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });

                        startLobbyListener(lobbyCode);
                        joinGame(lobbyCode, myUsername, true); 
                    } catch (error) {
                        console.error("Error creating lobby:", error);
                        alert("Failed to create lobby. Check console and Firebase Security Rules.");
                    }
                }
            });

            // Updated Join Lobby Logic
            joinLobbyBtn.addEventListener('click', async () => {
                myUsername = usernameInput.value.trim();
                lobbyCode = codeInput.value.trim().toUpperCase();
                
                if (myUsername && lobbyCode) {
                    try {
                        const lobbyRef = lobbiesCollection.doc(lobbyCode);
                        
                        await db.runTransaction(async (transaction) => {
                            const lobbyDoc = await transaction.get(lobbyRef);

                            if (!lobbyDoc.exists) {
                                throw new Error("Lobby does not exist.");
                            }
                            
                            const lobbyData = lobbyDoc.data();
                            if (lobbyData.status !== 'waiting') {
                                 throw new Error("Game is already in progress.");
                            }
                            if (lobbyData.players.find(p => p.name === myUsername)) {
                                 throw new Error("A player with this name is already in the lobby.");
                            }

                            const newPlayer = { name: myUsername, role: 'Player', status: 'connected' };
                            const updatedPlayers = [...lobbyData.players, newPlayer];

                            transaction.update(lobbyRef, { players: updatedPlayers });
                        });

                        startLobbyListener(lobbyCode);
                        joinGame(lobbyCode, myUsername, false); 

                    } catch (error) {
                        console.error("Error joining lobby:", error);
                        alert(`Failed to join lobby: ${error.message || error}. Check console and Firebase Security Rules.`);
                    }
                }
            });

            // --- 3. REAL-TIME SYNCHRONIZATION (LISTENER) ---

            function startLobbyListener(code) {
                // Listens for real-time changes to the lobby document
                lobbiesCollection.doc(code).onSnapshot((doc) => {
                    if (doc.exists) {
                        const data = doc.data();
                        
                        // Update player list for ALL connected clients
                        updatePlayerList(data.players.map(p => p.name));
                        
                        // Host visibility check (can only start if 3+ players and still waiting)
                        if (data.host === myUsername && data.players.length >= 3 && data.status === 'waiting') {
                            startGameBtn.style.display = 'block';
                        } else {
                            startGameBtn.style.display = 'none';
                        }
                        
                        // Game in Progress Logic (triggers for all players)
                        if (data.status === 'in-game') {
                            const me = data.players.find(p => p.name === myUsername);
                            
                            if (me) {
                                roleDisplay.innerHTML = (me.role === 'Imposter') ? 
                                    'üö® **YOU ARE THE IMPOSTER!** üö®' : 
                                    '‚úÖ **YOU ARE A CIVILIAN**';
                                wordDisplay.textContent = `Secret Word: ${me.word}`;
                                statusMessage.textContent = "Give your one-word clue now!";
                                inputArea.style.display = 'flex';
                                
                                // Reset clue button state on start of a new round
                                submitClueBtn.disabled = false;
                            }
                        }
                        
                        // Handle Clue Submission updates (simple real-time log)
                        if (data.lastClue) {
                            statusMessage.innerHTML = `**${data.lastClue.playerName}** submitted: *"${data.lastClue.clue}"*. Waiting for next...`;
                        }

                    } else {
                        // Lobby document was deleted
                        alert("The lobby was closed or deleted.");
                        window.location.reload(); 
                    }
                }, (error) => {
                    console.error("Listener error:", error);
                    alert("A real-time connection error occurred. Check Firebase rules/connection.");
                });
            }

            // --- 4. GAME START (HOST ACTION) & CLUES ---
            startGameBtn.addEventListener('click', async () => {
                if (!isHost) return; // Safety check
                
                try {
                    const lobbyDoc = await lobbiesCollection.doc(lobbyCode).get();
                    const players = lobbyDoc.data().players;
                    
                    if (players.length < 3) {
                         alert("Need at least 3 players to start!");
                         return;
                    }

                    // Simple Word List & Assignment (Host-side logic)
                    const civilianWords = ['PYRAMID', 'ZEBRA', 'PIZZA', 'SUNFLOWER'];
                    const imposterWords = ['SPHINX', 'STRIPE', 'BURGER', 'DAISY'];
                    
                    const wordIndex = Math.floor(Math.random() * civilianWords.length);
                    const secretWord = civilianWords[wordIndex];
                    const similarWord = imposterWords[wordIndex]; 
                    
                    const imposterIndex = Math.floor(Math.random() * players.length);
                    
                    const updatedPlayers = players.map((p, index) => ({
                        ...p,
                        role: (index === imposterIndex) ? 'Imposter' : 'Civilian',
                        word: (index === imposterIndex) ? similarWord : secretWord
                    }));

                    // Update Firestore: this triggers the 'in-game' logic on all devices via the listener
                    await lobbiesCollection.doc(lobbyCode).update({
                        status: 'in-game',
                        players: updatedPlayers,
                        round: 1,
                        clues: []
                    });
                    
                    startGameBtn.style.display = 'none'; // Hide button after start

                } catch (error) {
                    console.error("Error starting game:", error);
                    alert("Failed to start game. Check console/Firebase setup.");
                }
            });
            
            // Clue Submission Logic
            submitClueBtn.addEventListener('click', async () => {
                const clue = clueInput.value.trim();
                if (clue) {
                    submitClueBtn.disabled = true;
                    clueInput.value = '';
                    
                    try {
                        const lobbyRef = lobbiesCollection.doc(lobbyCode);
                        // Using 'firebase.firestore.FieldValue.arrayUnion' with the compat library
                        const newClue = { playerName: myUsername, clue: clue, timestamp: new Date().toISOString() };
                        
                        // Save the new clue and update the "lastClue" field for immediate feedback
                        await lobbyRef.update({
                            clues: firebase.firestore.FieldValue.arrayUnion(newClue),
                            lastClue: newClue 
                        });
                        
                    } catch (error) {
                        console.error("Error submitting clue:", error);
                        submitClueBtn.disabled = false; // Re-enable if submission fails
                        alert("Failed to submit clue.");
                    }
                }
            });

            // Initial check to set button state on load
            checkInputs();
        });
    </script>
</body>
</html>
