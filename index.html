<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Imposter — Lobby</title>
  <style>
    :root{ --bg:#0f1724; --card:#0b1220; --muted:#9aa7b7; --accent:#4a90e2; --accent-2:#28a745; --panel:#0f1a2b; }
    html,body{height:100%;margin:0}
    body{font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, Arial; background:linear-gradient(180deg,#071020 0%,#0b1320 100%); color:#e8f0fb; display:flex;align-items:center;justify-content:center;padding:28px}
    .card{width:980px;max-width:96%;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border-radius:14px;padding:18px;box-shadow:0 10px 40px rgba(2,6,23,0.7)}
    .hdr{display:flex;justify-content:space-between;align-items:center}
    h1{margin:0;font-size:20px}
    .muted{color:var(--muted);font-size:13px}

    .layout{display:flex;gap:16px;margin-top:14px}
    .left{width:320px}
    .right{flex:1}

    label{display:block;font-size:13px;margin-bottom:6px}
    input[type=text]{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
    button{padding:10px 12px;border-radius:10px;border:0;cursor:pointer}
    .btn-primary{background:var(--accent);color:white}
    .btn-success{background:var(--accent-2);color:white}
    .btn-ghost{background:transparent;color:var(--muted);border:1px solid rgba(255,255,255,0.03)}

    .panel{background:rgba(255,255,255,0.02);padding:12px;border-radius:10px;margin-top:12px}
    .player{display:flex;justify-content:space-between;padding:8px;border-radius:8px;background:rgba(255,255,255,0.01);margin-bottom:8px}
    .code{font-weight:700;padding:6px 10px;border-radius:8px;background:rgba(255,255,255,0.02);letter-spacing:3px}

    #log{height:300px;overflow:auto;padding:12px;border-radius:8px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00))}

    footer{margin-top:10px;font-size:13px;color:var(--muted)}

    @media (max-width:880px){.layout{flex-direction:column}.left{width:100%}}
  </style>
</head>
<body>
  <div class="card">
    <div class="hdr"><div><h1>Imposter</h1><div class="muted">Create a lobby and invite friends with the code</div></div><div class="muted">Realtime: Firebase</div></div>

    <div class="layout">
      <div class="left">
        <div id="lobbyCard">
          <label for="name">Your name</label>
          <input id="name" type="text" placeholder="e.g. Charlie" />

          <div style="display:flex;gap:8px;margin-top:10px">
            <button id="createBtn" class="btn-primary">Create lobby</button>
            <input id="joinCode" type="text" placeholder="CODE" style="width:120px;text-transform:uppercase" />
            <button id="joinBtn" class="btn-ghost">Join</button>
          </div>

          <div class="panel" style="margin-top:12px">
            <div class="muted small">Lobby info</div>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
              <div>Code <div id="codeDisplay" class="code">—</div></div>
              <div style="text-align:right">Players <div id="playersCount">0</div></div>
            </div>
          </div>
        </div>

        <div class="panel" style="margin-top:12px">
          <div class="muted">Log</div>
          <div id="log"></div>
          <footer>Tip: open this file in multiple windows to test with friends locally.</footer>
        </div>
      </div>

      <div class="right">
        <div class="panel" id="playersCard" style="display:none">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><strong>Lobby</strong><div class="muted">Code: <span id="codeDisplay"></span></div></div>
            <div><button id="startBtn" class="btn-success" style="display:none">Start game</button></div>
          </div>
          <div style="margin-top:10px" id="playersList"></div>
          <div style="margin-top:10px" class="muted">Host can start the game once there are at least 3 players.</div>
        </div>
      </div>
    </div>
  </div>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
import { getDatabase, ref, set, get, onValue, update, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js';

const firebaseConfig = {apiKey:"AIzaSyDlm1nd6P6VY6HiFLgy2rZPeLLr-VwYaD4",authDomain:"imposter-5142b.firebaseapp.com",databaseURL:"https://imposter-5142b-default-rtdb.europe-west1.firebasedatabase.app",projectId:"imposter-5142b",storageBucket:"imposter-5142b.appspot.com",messagingSenderId:"500677632460",appId:"1:500677632460:web:236568f1cb93c31a7bbd69",measurementId:"G-RWF1030VF1"};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let clientId = localStorage.getItem('imposter_clientId') || ('c_'+Math.random().toString(36).slice(2,10));
localStorage.setItem('imposter_clientId', clientId);
let currentLobby = null;

const el = id => document.getElementById(id);
const logMsg = t => { const d = document.createElement('div'); d.textContent = '[' + new Date().toLocaleTimeString() + '] ' + t; el('log').prepend(d); };
const genCode = ()=> Math.random().toString(36).substring(2,8).toUpperCase();

window.createLobby = async () => {
  const name = el('name').value.trim(); if(!name) return alert('Enter a name');
  const code = genCode(); currentLobby = code;
  const lobbyRef = ref(db,'lobbies/'+code);
  try {
    await set(lobbyRef,{hostId:clientId,created:serverTimestamp(),started:false});
    await set(ref(db,'lobbies/'+code+'/players/'+clientId),{name,clientId,alive:true,role:'unassigned',joined:serverTimestamp()});
    localStorage.setItem('imposter_lobby',code);
    localStorage.setItem('imposter_playerId',clientId);
    listenLobby(code);
    logMsg('Lobby created: '+code+' (you are host)');
  } catch(e){ alert('Failed: '+e.message); }
};

window.joinLobby = async () => {
  const name = el('name').value.trim();
  const code = el('joinCode').value.trim().toUpperCase();
  if(!name||!code) return alert('Enter name and code');
  const lobbyRef = ref(db,'lobbies/'+code);
  const snap = await get(lobbyRef);
  if(!snap.exists()) return alert('Lobby not found');
  await set(ref(db,'lobbies/'+code+'/players/'+clientId),{name,clientId,alive:true,role:'unassigned',joined:serverTimestamp()});
  localStorage.setItem('imposter_lobby',code);
  localStorage.setItem('imposter_playerId',clientId);
  currentLobby = code;
  listenLobby(code);
  logMsg('Joined lobby '+code);
};

function listenLobby(code){
  currentLobby = code;
  el('lobbyCard').style.display='none';
  el('playersCard').style.display='block';
  el('codeDisplay').textContent=code;
  const playersRef = ref(db,'lobbies/'+code+'/players');
  onValue(playersRef,snap=>{
    const list = el('playerList'); list.innerHTML='';
    let count=0;
    snap.forEach(child=>{count++; const p=child.val(); const li=document.createElement('div'); li.className='player'; li.textContent=p.name; list.appendChild(li);});
    el('startBtn').style.display=(snap.size>=3&&snap.ref.parent.child('hostId').val()===clientId)?'inline-block':'none';
  });
}

window.startGame = async () => {
  if(!currentLobby) return;
  const lobbyRef = ref(db,'lobbies/'+currentLobby);
  const snap = await get(lobbyRef);
  if(!snap.exists()) return alert('Lobby missing');
  const data = snap.val();
  const players = data.players||{};
  const keys = Object.keys(players);
  if(keys.length<3) return alert('Need at least 3 players');
  const impostersCount = Math.max(1,Math.floor(keys.length/4));
  const shuffled = keys.sort(()=>Math.random()-0.5);
  const updates = {}; shuffled.forEach((k,i)=>{updates['players/'+k+'/role']=i<impostersCount?'imposter':'crewmate'; updates['players/'+k+'/alive']=true;});
  updates['started']=true; await update(lobbyRef,updates);
  logMsg('Game started');
};

window.addEventListener('load',()=>{
  el('createBtn').onclick=createLobby;
  el('joinBtn').onclick=joinLobby;
  el('startBtn').onclick=startGame;
});

const gameUI = document.createElement('div');
gameUI.id='gameUI'; gameUI.style.display='none';
gameUI.innerHTML=`<div class="panel" style="margin-top:20px;padding:20px"><h2>Game in progress</h2><p id="yourRole" class="muted"></p></div>`;
document.body.appendChild(gameUI);

import('https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js').then(({getDatabase, ref, onValue})=>{
  const db = getDatabase();
  const lobbyCode = localStorage.getItem('imposter_lobby');
  if(!lobbyCode) return;
  const lobbyRef = ref(db,'lobbies/'+lobbyCode);
  onValue(lobbyRef,snap=>{
    const data=snap.val(); if(!data) return;
    if(data.started){ document.querySelector('.layout').style.display='none'; gameUI.style.display='block';
      const me=localStorage.getItem('imposter_playerId');
      const role=data.players?.[me]?.role||'unknown';
      document.getElementById('yourRole').textContent='Your role: '+role;
    }
  });
});
</script>
</body>
</html>
